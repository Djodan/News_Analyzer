================================================================================
                    MT5 â†’ PYTHON DATA COLLECTION REQUIREMENTS
                          News Analyzer Testing Framework
================================================================================

PHILOSOPHY: Keep MT5 Client Lightweight, Compute on Python Server
- MT5 sends RAW DATA only (prices, ATR, account info)
- Python calculates EVERYTHING ELSE (pips, P&L %, MAE, MFE, durations, etc.)
- This keeps EA fast and reduces MQL5 complexity

PACKET ARCHITECTURE: Hybrid Frequency-Based + Event-Driven System
- 5 packet types with different frequencies and triggers
- Core state (Packet A) sent every 30 seconds for consistency
- Event-driven packets (Packet E) sent immediately on trade close
- High-frequency analytics (Packet D) sent every 5 seconds when positions open
- Smart batching to reduce bandwidth while maintaining data freshness

================================================================================
SECTION 1: PACKET STRUCTURE OVERVIEW
================================================================================

The data collection is split into 5 packet types, each with specific frequency
and trigger conditions. This ensures data freshness while minimizing bandwidth.

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PACKET A - TRADE_STATE (Core State Snapshot)                               â”‚
â”‚ Frequency: Every 30 seconds (OnTimer)                                       â”‚
â”‚ Size: 500-2000 bytes (varies with open position count)                      â”‚
â”‚ Priority: HIGH                                                               â”‚
â”‚ Trigger: OnTimer() periodic execution                                       â”‚
â”‚                                                                              â”‚
â”‚ DATA SENT:                                                                   â”‚
â”‚   â€¢ id (int) - Client ID number                                             â”‚
â”‚   â€¢ mode (string) - "Sender" or "Receiver"                                  â”‚
â”‚   â€¢ timestamp (string) - ISO format "2025-11-07T14:32:18.456"              â”‚
â”‚   â€¢ open (array) - All open positions:                                      â”‚
â”‚       - ticket (ulong) - Position ticket number                             â”‚
â”‚       - symbol (string) - "EURUSD", "GBPUSD", etc.                         â”‚
â”‚       - type (int) - 0=BUY, 1=SELL                                          â”‚
â”‚       - volume (double) - Lot size (e.g., 0.08)                            â”‚
â”‚       - openPrice (double) - Entry price                                    â”‚
â”‚       - price (double) - Current market price                               â”‚
â”‚       - sl (double) - Stop loss price                                       â”‚
â”‚       - tp (double) - Take profit price                                     â”‚
â”‚       - openTime (string) - ISO format timestamp                            â”‚
â”‚       - magic (long) - Magic number                                         â”‚
â”‚       - comment (string) - EA comment (contains TID link)                   â”‚
â”‚   â€¢ closedOffline (array) - Positions closed while server down:            â”‚
â”‚       - deal (ulong) - Deal ticket number                                   â”‚
â”‚       - symbol (string)                                                     â”‚
â”‚       - type (int) - 0=BUY, 1=SELL                                          â”‚
â”‚       - volume (double)                                                     â”‚
â”‚       - openPrice (double)                                                  â”‚
â”‚       - closePrice (double)                                                 â”‚
â”‚       - profit (double) - In account currency                               â”‚
â”‚       - swap (double)                                                       â”‚
â”‚       - commission (double)                                                 â”‚
â”‚       - closeTime (string) - ISO format timestamp                           â”‚
â”‚   â€¢ closedOnline (array) - Same structure as closedOffline                 â”‚
â”‚   â€¢ symbolsCurrentlyOpen (array of strings) - ["EURUSD", "GBPUSD"]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PACKET B - ACCOUNT_INFO (Account Balance & Equity)                         â”‚
â”‚ Frequency: Every 30-60 seconds OR on significant change (>1% balance)       â”‚
â”‚ Size: ~100 bytes                                                             â”‚
â”‚ Priority: MEDIUM                                                             â”‚
â”‚ Trigger: OnTimer() with change detection OR 60-second minimum interval      â”‚
â”‚                                                                              â”‚
â”‚ DATA SENT:                                                                   â”‚
â”‚   â€¢ packetType (string) - "account_info"                                    â”‚
â”‚   â€¢ timestamp (string) - ISO format "2025-11-07T14:32:18.456"              â”‚
â”‚   â€¢ id (int) - Client ID number                                             â”‚
â”‚   â€¢ account (object):                                                        â”‚
â”‚       - balance (double) - Current account balance                          â”‚
â”‚       - equity (double) - Current equity (balance + unrealized P&L)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PACKET C - SYMBOL_MARKET_DATA (ATR, Spreads, Prices for all 12 pairs)     â”‚
â”‚ Frequency: Every 30 seconds                                                  â”‚
â”‚ Size: ~800 bytes (12 pairs Ã— 5 fields)                                      â”‚
â”‚ Priority: MEDIUM                                                             â”‚
â”‚ Trigger: OnTimer() periodic execution                                       â”‚
â”‚                                                                              â”‚
â”‚ DATA SENT (for EACH of 12 pairs):                                          â”‚
â”‚   â€¢ packetType (string) - "symbol_data"                                     â”‚
â”‚   â€¢ timestamp (string) - ISO format "2025-11-07T14:32:18.456"              â”‚
â”‚   â€¢ id (int) - Client ID number                                             â”‚
â”‚   â€¢ symbols (object with 12 pairs):                                         â”‚
â”‚       EURUSD, GBPUSD, USDJPY, USDCHF, AUDUSD, USDCAD,                      â”‚
â”‚       NZDUSD, EURJPY, GBPJPY, EURGBP, XAUUSD, XAGUSD                       â”‚
â”‚       Each pair contains:                                                    â”‚
â”‚       - atr (double) - 14-period ATR on M30 chart                           â”‚
â”‚       - current_price (double) - Current bid price                          â”‚
â”‚       - spread (double) - Current spread in points                          â”‚
â”‚       - high (double) - Recent high for volatility                          â”‚
â”‚       - low (double) - Recent low for volatility                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PACKET D - POSITION_ANALYTICS (Real-time MAE/MFE updates)                  â”‚
â”‚ Frequency: Every 5 seconds (only when positions are open)                   â”‚
â”‚ Size: ~200 bytes per open position                                          â”‚
â”‚ Priority: LOW                                                                â”‚
â”‚ Trigger: OnTick() with tick counter (every 50 ticks â‰ˆ 5 seconds)           â”‚
â”‚                                                                              â”‚
â”‚ DATA SENT (for EACH open position):                                        â”‚
â”‚   â€¢ packetType (string) - "position_analytics"                              â”‚
â”‚   â€¢ timestamp (string) - ISO format "2025-11-07T14:32:23.789"              â”‚
â”‚   â€¢ id (int) - Client ID number                                             â”‚
â”‚   â€¢ analytics (array) - One entry per open position:                        â”‚
â”‚       - ticket (ulong) - Position ticket number                             â”‚
â”‚       - symbol (string) - Trading pair                                      â”‚
â”‚       - unrealized_pnl_pips (double) - Current P&L in pips                  â”‚
â”‚       - mae_pips (double) - Max Adverse Excursion in pips                   â”‚
â”‚       - mfe_pips (double) - Max Favorable Excursion in pips                 â”‚
â”‚       - current_price (double) - Current market price                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PACKET E - CLOSE_DETAILS (Immediate trade close notification)              â”‚
â”‚ Frequency: IMMEDIATE on trade close event                                   â”‚
â”‚ Size: ~150 bytes per closed trade                                           â”‚
â”‚ Priority: **CRITICAL**                                                       â”‚
â”‚ Trigger: OnTrade() event detection (position close)                         â”‚
â”‚                                                                              â”‚
â”‚ DATA SENT:                                                                   â”‚
â”‚   â€¢ packetType (string) - "close_details"                                   â”‚
â”‚   â€¢ timestamp (string) - ISO format "2025-11-07T14:45:12.123"              â”‚
â”‚   â€¢ id (int) - Client ID number                                             â”‚
â”‚   â€¢ closed_trade (object):                                                   â”‚
â”‚       - ticket (ulong) - Position ticket number                             â”‚
â”‚       - deal (ulong) - Deal ticket number                                   â”‚
â”‚       - symbol (string) - Trading pair                                      â”‚
â”‚       - type (int) - 0=BUY, 1=SELL                                          â”‚
â”‚       - volume (double) - Lot size                                          â”‚
â”‚       - openPrice (double) - Entry price                                    â”‚
â”‚       - closePrice (double) - Exit price                                    â”‚
â”‚       - openTime (string) - ISO format timestamp                            â”‚
â”‚       - closeTime (string) - ISO format timestamp                           â”‚
â”‚       - close_reason (string) - "TP", "SL", or "Manual"                     â”‚
â”‚       - mae_pips (double) - Final MAE in pips                               â”‚
â”‚       - mfe_pips (double) - Final MFE in pips                               â”‚
â”‚       - profit (double) - Profit in account currency                        â”‚
â”‚       - swap (double) - Swap fees                                           â”‚
â”‚       - commission (double) - Commission fees                               â”‚
â”‚       - comment (string) - EA comment (contains TID link)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BANDWIDTH ESTIMATION:
- Packet A: 1.5 KB Ã— 2/minute = 3 KB/min
- Packet B: 0.1 KB Ã— 1.5/minute = 0.15 KB/min
- Packet C: 0.8 KB Ã— 2/minute = 1.6 KB/min
- Packet D: 0.4 KB Ã— 12/minute (avg 2 positions) = 4.8 KB/min
- Packet E: 0.15 KB Ã— 0-10/hour (event-based) = negligible
Total: ~9.5 KB/minute = ~570 KB/hour = ~13.7 MB/day

================================================================================
SECTION 2: PACKET A - TRADE_STATE (CURRENT SYSTEM - ENHANCED)
================================================================================

TRIGGER: OnTimer() - every 30 seconds
ROUTE: POST / with "packetType": "trade_state"
PURPOSE: Complete snapshot of all open and closed positions

âœ… CURRENT DATA (already being sent - keep as is):

1. CLIENT IDENTITY
   - id (client ID number)
   - mode (Sender/Receiver)

2. OPEN POSITIONS (per position)
   - ticket (position ticket number)
   - symbol (trading pair, e.g., "EURUSD")
   - type (0=BUY, 1=SELL)
   - volume (lot size, e.g., 0.08)
   - openPrice (entry price)
   - price (current market price)
   - sl (stop loss price)
   - tp (take profit price)
   - magic (magic number)
   - comment (EA comment field - contains TID link)
   - openTime (timestamp when opened) â† ALREADY EXISTS in openOpenTimes[]

3. CLOSED POSITIONS - OFFLINE (closed while server was down)
   - deal (deal ticket number)
   - symbol
   - type (0=BUY, 1=SELL)
   - volume
   - openPrice
   - closePrice
   - profit (in account currency)
   - swap
   - commission
   - closeTime (timestamp)

4. CLOSED POSITIONS - ONLINE (closed while server was connected)
   - Same fields as offline closed positions

5. SYMBOLS CURRENTLY OPEN
   - Array of unique symbol names with open positions

6. TRADE ACKNOWLEDGMENT DATA (on ACK)
   - cmdId (command ID)
   - success (true/false)
   - details object with:
     â€¢ retcode (MT5 return code)
     â€¢ message (description)
     â€¢ symbol
     â€¢ type ("BUY" or "SELL")
     â€¢ volume
     â€¢ paid (actual execution price)
     â€¢ sl (actual stop loss set)
     â€¢ tp (actual take profit set)

7. TRADE OUTCOME REPORTING (deprecated - replaced by Packet E)
   - ticket (position ticket)
   - outcome ("TP" or "SL")

JSON STRUCTURE FOR PACKET A:
{
  "packetType": "trade_state",
  "timestamp": "2025-11-07T14:32:18.456",
  "id": 1,
  "mode": "Sender",
  "open": [ /* array of open positions */ ],
  "closedOffline": [ /* positions closed while server down */ ],
  "closedOnline": [ /* positions closed while server connected */ ],
  "symbolsCurrentlyOpen": [ "EURUSD", "GBPUSD" ]
}

================================================================================
SECTION 3: PACKET B - ACCOUNT_INFO
================================================================================

TRIGGER: OnTimer() every 30-60 seconds OR when balance changes >1%
ROUTE: POST / with "packetType": "account_info"
PURPOSE: Track account balance for weekly profit targets and risk management

ğŸ”´ NEW DATA TO SEND:

CATEGORY A: ACCOUNT INFORMATION
-------------------------------------------------------------------
1. account_balance (double)
   - Current account balance in account currency
   - Used for: Weekly profit target tracking (S1-S5)
   - Calculation: AccountInfoDouble(ACCOUNT_BALANCE)

2. account_equity (double)
   - Current account equity (balance + unrealized P&L)
   - Used for: Risk management, drawdown tracking
   - Calculation: AccountInfoDouble(ACCOUNT_EQUITY)

SMART SENDING LOGIC:
- Send every 60 seconds minimum (keep server updated)
- Send immediately if balance changed >1% since last send
- Send immediately if weekly target reached
- Skip if balance unchanged and <60 seconds elapsed

JSON STRUCTURE FOR PACKET B:
{
  "packetType": "account_info",
  "timestamp": "2025-11-07T14:32:18.456",
  "id": 1,
  "account": {
    "balance": 100000.00,
    "equity": 100245.50
  }
}

MQL5 IMPLEMENTATION:
static double lastSentBalance = 0.0;
static datetime lastSentTime = 0;

void OnTimer()
{
    double currentBalance = AccountInfoDouble(ACCOUNT_BALANCE);
    double balanceChange = MathAbs((currentBalance - lastSentBalance) / lastSentBalance);
    datetime now = TimeCurrent();
    
    // Send if changed >1% OR 60+ seconds elapsed
    if(balanceChange > 0.01 || (now - lastSentTime) >= 60)
    {
        SendPacket_B_AccountInfo();
        lastSentBalance = currentBalance;
        lastSentTime = now;
    }
}

================================================================================
SECTION 4: PACKET C - SYMBOL_MARKET_DATA
================================================================================

TRIGGER: OnTimer() - every 30 seconds
ROUTE: POST / with "packetType": "symbol_data"
PURPOSE: Provide ATR, spreads, and prices for position sizing and volatility filtering

ğŸ”´ NEW DATA TO SEND:

CATEGORY B: SYMBOL DATA (for each pair in _Symbols_)
---------------------------------------------------------------------------
For symbols: EURUSD, GBPUSD, USDJPY, USDCHF, AUDUSD, USDCAD, NZDUSD,
             EURJPY, GBPJPY, EURGBP, XAUUSD, XAGUSD

3. ATR (double, 5 decimals)
   - 14-period ATR on 30-minute chart
   - Used for: Position sizing (S4/S5), volatility filtering
   - Calculation: iATR(symbol, PERIOD_M30, 14)
   - Example: 0.00045 for EURUSD means 4.5 pips

4. spread (double)
   - Current spread in points
   - Used for: Trade cost analysis, filter high spread times
   - Calculation: SymbolInfoInteger(symbol, SYMBOL_SPREAD)

5. high (double)
   - Recent high price for volatility calculation
   - Used for: Python-side volatility metric
   - Calculation: iHigh(symbol, PERIOD_M30, 0) or last 1-hour high

6. low (double)
   - Recent low price for volatility calculation
   - Used for: Python-side volatility metric
   - Calculation: iLow(symbol, PERIOD_M30, 0) or last 1-hour low

JSON STRUCTURE FOR PACKET C:
{
  "packetType": "symbol_data",
  "timestamp": "2025-11-07T14:32:18.456",
  "id": 1,
  "symbols": {
    "EURUSD": {
      "atr": 0.00045,
      "current_price": 1.0850,
      "spread": 1.5,
      "high": 1.0870,
      "low": 1.0835
    },
    "GBPUSD": { ... },
    "USDJPY": { ... },
    "USDCHF": { ... },
    "AUDUSD": { ... },
    "USDCAD": { ... },
    "NZDUSD": { ... },
    "EURJPY": { ... },
    "GBPJPY": { ... },
    "EURGBP": { ... },
    "XAUUSD": { ... },
    "XAGUSD": { ... }
  }
}

MQL5 IMPLEMENTATION:
- Create ATR handles in OnInit() for all 12 pairs
- On OnTimer(), loop through all pairs and collect data
- Build JSON with symbol data section
- Send every 30 seconds regardless of changes (ATR needed for position sizing)

================================================================================
SECTION 5: PACKET D - POSITION_ANALYTICS
================================================================================

TRIGGER: OnTick() with 50-tick counter (~5 seconds) - only when positions open
ROUTE: POST / with "packetType": "position_analytics"
PURPOSE: Real-time MAE/MFE tracking for stop loss optimization

ğŸ”´ NEW DATA TO SEND:

CATEGORY C: POSITION TRACKING ENHANCEMENTS (per open position)
---------------------------------------------------------------
7. unrealized_pnl_pips (double)
   - Unrealized P&L in PIPS (not account currency)
   - Used for: Real-time monitoring, MAE/MFE tracking
   - Python will calculate this, but need point/pip info

8. mae_pips (double)
   - Max Adverse Excursion in pips since position opened
   - Used for: CSV logging, stop loss optimization analysis
   - Track lowest pip value reached for BUY, highest for SELL
   - Example: BUY at 1.0850, dropped to 1.0842 = -8 pips MAE

9. mfe_pips (double)
   - Max Favorable Excursion in pips since position opened
   - Used for: CSV logging, take profit optimization analysis
   - Track highest pip value reached for BUY, lowest for SELL
   - Example: BUY at 1.0850, peaked at 1.0878 = +28 pips MFE

JSON STRUCTURE FOR PACKET D:
{
  "packetType": "position_analytics",
  "timestamp": "2025-11-07T14:32:23.789",
  "id": 1,
  "analytics": [
    {
      "ticket": 12345,
      "symbol": "EURUSD",
      "unrealized_pnl_pips": 15.0,
      "mae_pips": -8.0,
      "mfe_pips": 28.0,
      "current_price": 1.0865
    },
    {
      "ticket": 12346,
      "symbol": "GBPUSD",
      "unrealized_pnl_pips": -12.5,
      "mae_pips": -18.0,
      "mfe_pips": 3.0,
      "current_price": 1.2745
    }
  ]
}

MQL5 IMPLEMENTATION:
// Global tracking arrays
double g_MAE[];  // Indexed by position in openTickets array
double g_MFE[];

void OnTick()
{
    static int tickCounter = 0;
    tickCounter++;
    
    // Update MAE/MFE on every tick for all open positions
    UpdateMAE_MFE();
    
    // Send analytics packet every 50 ticks if positions exist
    if(ArraySize(openTickets) > 0 && tickCounter % 50 == 0)
    {
        SendPacket_D_PositionAnalytics();
    }
}

void UpdateMAE_MFE()
{
    for(int i=0; i<ArraySize(openTickets); i++)
    {
        double currentPips = CalculatePipsFromEntry(i);
        
        // Update MAE (most negative for BUY, most positive for SELL)
        if(openTypes[i] == POSITION_TYPE_BUY)
        {
            if(currentPips < g_MAE[i]) g_MAE[i] = currentPips;
        }
        else
        {
            if(currentPips > g_MAE[i]) g_MAE[i] = currentPips;
        }
        
        // Update MFE (most positive for BUY, most negative for SELL)
        if(openTypes[i] == POSITION_TYPE_BUY)
        {
            if(currentPips > g_MFE[i]) g_MFE[i] = currentPips;
        }
        else
        {
            if(currentPips < g_MFE[i]) g_MFE[i] = currentPips;
        }
    }
}

================================================================================
SECTION 6: PACKET E - CLOSE_DETAILS (EVENT-DRIVEN)
================================================================================

TRIGGER: OnTrade() - IMMEDIATE when position closes
ROUTE: POST / with "packetType": "close_details"
PURPOSE: Capture final trade metrics for CSV logging with minimal latency (<50ms)

ğŸ”´ NEW DATA TO SEND:

CATEGORY D: CLOSED POSITION ENHANCEMENTS
----------------------------------------------------------------
10. openTime (datetime)
    - Position open timestamp (already exists as openOpenTimes[])
    - Ensure it's included in closed position arrays
    - Used for: Duration calculation (Python side)

11. close_reason (string)
    - "TP", "SL", or "Manual"
    - Used for: CSV logging, win/loss analysis
    - Detect from: PositionGetDouble(POSITION_TP) hit, SL hit, or manual close

JSON STRUCTURE FOR PACKET E:
{
  "packetType": "close_details",
  "timestamp": "2025-11-07T14:45:12.123",
  "id": 1,
  "closed_trade": {
    "ticket": 12345,
    "deal": 67890,
    "symbol": "EURUSD",
    "type": 0,
    "volume": 0.08,
    "openPrice": 1.0850,
    "closePrice": 1.0873,
    "openTime": "2025-11-07T08:30:03",
    "closeTime": "2025-11-07T14:45:12",
    "close_reason": "TP",
    "mae_pips": -8.0,
    "mfe_pips": 28.0,
    "profit": 18.40,
    "swap": 0.0,
    "commission": -0.50,
    "comment": "TID_5_1"
  }
}

MQL5 IMPLEMENTATION:
void OnTrade()
{
    // Detect position close by comparing current positions vs last snapshot
    // When close detected, immediately send Packet E with full details
    
    for(int i=0; i<ArraySize(previousOpenTickets); i++)
    {
        ulong ticket = previousOpenTickets[i];
        if(!IsTicketStillOpen(ticket))
        {
            // Position closed - get details from history
            if(HistorySelectByPosition(PositionGetInteger(POSITION_IDENTIFIER)))
            {
                // Extract close details
                string closeReason = DetermineCloseReason(ticket);
                double finalMAE = g_MAE[i];
                double finalMFE = g_MFE[i];
                
                // Send immediately
                SendPacket_E_CloseDetails(ticket, closeReason, finalMAE, finalMFE);
            }
        }
    }
}

string DetermineCloseReason(ulong ticket)
{
    // Check deal history to determine if TP, SL, or manual close
    if(HistoryDealSelect(ticket))
    {
        long dealEntry = HistoryDealGetInteger(ticket, DEAL_ENTRY);
        if(dealEntry == DEAL_ENTRY_OUT)
        {
            // Check if price hit TP or SL
            // Return "TP", "SL", or "Manual"
        }
    }
    return "Manual";
}

CRITICAL TIMING:
- Packet E MUST be sent within 50ms of position close
- This ensures MAE/MFE data is captured before memory cleared
- Python receives close notification immediately for CSV logging
- No waiting for next OnTimer() cycle (could be 30 seconds away)

================================================================================
SECTION 7: COMPLETE DATA FLOW TIMELINE
================================================================================

EXAMPLE: 60-SECOND TIMELINE WITH ALL PACKETS

Time 0:00 - OnTimer() fires
  â†’ Send Packet A (trade_state) - 1.5 KB
  â†’ Send Packet B (account_info) - 0.1 KB
  â†’ Send Packet C (symbol_data) - 0.8 KB
  Total: 2.4 KB sent in <200ms

Time 0:03 - OnTick() counter reaches 50
  â†’ Send Packet D (position_analytics) - 0.4 KB (2 positions)

Time 0:06 - OnTick() counter reaches 100
  â†’ Send Packet D (position_analytics) - 0.4 KB

Time 0:09 - OnTick() counter reaches 150
  â†’ Send Packet D (position_analytics) - 0.4 KB

Time 0:11 - OnTrade() detects position close
  â†’ Send Packet E (close_details) IMMEDIATELY - 0.15 KB
  â†’ Python writes to CSV within 100ms of close event

Time 0:12 - OnTick() counter reaches 200
  â†’ Send Packet D (position_analytics) - 0.2 KB (1 position remaining)

Time 0:30 - OnTimer() fires again
  â†’ Send Packet A (trade_state) - 1.0 KB (1 position now)
  â†’ Skip Packet B (balance unchanged, <60 sec elapsed)
  â†’ Send Packet C (symbol_data) - 0.8 KB
  Total: 1.8 KB sent

Time 0:33 - OnTick() counter reaches 50
  â†’ Send Packet D (position_analytics) - 0.2 KB

Total data sent in 60 seconds: ~8.5 KB
Average bandwidth: 142 bytes/second

================================================================================
SECTION 8: PYTHON SERVER ROUTING LOGIC
================================================================================

SERVER-SIDE PACKET ROUTER (Server.py):

def do_POST(self):
    data = json.loads(body.decode("utf-8"))
    packet_type = data.get("packetType", "trade_state")  # Default for backward compatibility
    client_id = data.get("id")
    
    print(f"[{client_id}] Received {packet_type} at {data.get('timestamp')}")
    
    # Route to appropriate handler
    if packet_type == "trade_state":
        handle_packet_a_trade_state(data)
    elif packet_type == "account_info":
        handle_packet_b_account_info(data)
    elif packet_type == "symbol_data":
        handle_packet_c_symbol_data(data)
    elif packet_type == "position_analytics":
        handle_packet_d_position_analytics(data)
    elif packet_type == "close_details":
        handle_packet_e_close_details(data)  # PRIORITY: Write to CSV immediately
    else:
        print(f"Unknown packet type: {packet_type}")
        self._send_json(400, {"error": "unknown_packet_type"})
        return
    
    self._send_json(200, {"status": "ok", "packet": packet_type})

HANDLER FUNCTIONS:

def handle_packet_a_trade_state(data):
    """Update _Trades_ dictionary with current open/closed positions"""
    # Existing ingest_payload() logic
    pass

def handle_packet_b_account_info(data):
    """Update accBalance and check weekly profit targets"""
    Globals.accBalance = data["account"]["balance"]
    Globals.accEquity = data["account"]["equity"]
    
    # Check if weekly target reached
    if Globals.weekly_cumulative_return >= Globals.weekly_profit_target:
        Globals.weekly_target_reached = True
        print(f"ğŸ¯ Weekly profit target reached! {Globals.weekly_cumulative_return:.2f}%")

def handle_packet_c_symbol_data(data):
    """Update _Symbols_ dictionary with ATR and market data"""
    for symbol, symbol_data in data["symbols"].items():
        if symbol in Globals._Symbols_:
            Globals._Symbols_[symbol]["ATR"] = symbol_data["atr"]
            Globals._Symbols_[symbol]["current_price"] = symbol_data["current_price"]
            Globals._Symbols_[symbol]["spread"] = symbol_data["spread"]
            # Store high/low for volatility calculation

def handle_packet_d_position_analytics(data):
    """Update real-time MAE/MFE in _Trades_ dictionary"""
    for analytics in data["analytics"]:
        ticket = analytics["ticket"]
        # Find corresponding TID in _Trades_ via comment field
        for tid, trade in Globals._Trades_.items():
            if trade.get("ticket") == ticket and trade["status"] == "open":
                trade["mae"] = analytics["mae_pips"]
                trade["mfe"] = analytics["mfe_pips"]
                trade["unrealized_pnl"] = analytics["unrealized_pnl_pips"]

def handle_packet_e_close_details(data):
    """CRITICAL: Write closed trade to CSV immediately"""
    closed = data["closed_trade"]
    ticket = closed["ticket"]
    
    # Find TID from ticket
    tid = find_tid_by_ticket(ticket)
    if tid:
        trade = Globals._Trades_[tid]
        
        # Update with final close data
        trade["exit_price"] = closed["closePrice"]
        trade["exit_time"] = closed["closeTime"]
        trade["close_reason"] = closed["close_reason"]
        trade["mae"] = closed["mae_pips"]
        trade["mfe"] = closed["mfe_pips"]
        trade["profit"] = closed["profit"]
        trade["status"] = "closed"
        
        # Calculate derived metrics
        trade["pl_pips"] = calculate_pips(trade)
        trade["return_pct"] = (closed["profit"] / Globals.accBalance) * 100
        trade["duration_min"] = calculate_duration(trade)
        trade["sl_hit"] = closed["close_reason"] == "SL"
        trade["tp_hit"] = closed["close_reason"] == "TP"
        
        # Write to CSV IMMEDIATELY
        write_trade_to_csv(trade)
        print(f"âœ… Trade {tid} written to CSV: {closed['symbol']} {closed['close_reason']} "
              f"{trade['pl_pips']:+.1f} pips, {trade['return_pct']:+.2f}%")

================================================================================
SECTION 9: PYTHON-SIDE CALCULATIONS (DO NOT SEND FROM MT5)
================================================================================

Python will calculate ALL of these from raw data:

1. pl_pips = (closePrice - openPrice) / point Ã— sign
2. return_pct = (profit / account_balance) Ã— 100
3. duration_min = (closeTime - openTime) / 60
4. reaction_delay_sec = (entry_time - event_time) / 1000
5. surprise_strength = (actual - forecast) / forecast
6. market_volatility = (high - low) / ATR
7. entry_atr = ATR value at entry time (from _Symbols_)
8. position_count = len([t for t in _Trades_ if open])
9. sentiment_agreement = bullish currencies vs bearish
10. sl_hit = True if close_reason == "SL"
11. tp_hit = True if close_reason == "TP"
12. close_type = "TP", "SL", "Manual", "Timeout", "Reversal"
13. weekly_gain = sum profits for this symbol this week
14. weekly_drawdown = max drawdown for symbol this week
15. traded_this_week = True if pair traded this week (S4)

WHY? Because:
- Python has access to event data (forecast, actual, event time)
- Python has access to _Symbols_ and _Trades_ history
- Python has datetime libraries for easy time math
- Keeps MQL5 code simple and fast

================================================================================
SECTION 10: IMPLEMENTATION PRIORITY & PHASES
================================================================================

PHASE 1: CRITICAL - Core Packet Infrastructure (Week 1, Days 1-2)
------------------------------------------------------------------
Priority: BLOCKING - Must complete before any testing
Estimated Time: 4-6 hours

1. âœ… Packet A - Keep existing trade_state (already works)
2. ğŸ”´ Add "packetType" field to Packet A JSON
3. ğŸ”´ Implement Packet E - close_details (event-driven)
   - OnTrade() detection logic
   - Immediate send on close
   - MAE/MFE capture before cleanup
4. ğŸ”´ Python routing: do_POST() packet type router
5. ğŸ”´ Python handler: handle_packet_e_close_details()
6. ğŸ”´ CSV writer: write_trade_to_csv() function

DELIVERABLE: Real-time trade close logging to CSV with MAE/MFE

PHASE 2: CRITICAL - Account & Symbol Data (Week 1, Days 3-4)
-------------------------------------------------------------
Priority: BLOCKING for S4/S5 strategies
Estimated Time: 4-5 hours

1. ğŸ”´ Implement Packet B - account_info
   - Smart sending (change detection)
   - Balance/equity tracking
2. ğŸ”´ Implement Packet C - symbol_data
   - ATR handles for 12 pairs
   - 30-second periodic send
3. ğŸ”´ Python handler: handle_packet_b_account_info()
4. ğŸ”´ Python handler: handle_packet_c_symbol_data()
5. ğŸ”´ Update _Symbols_ with ATR data

DELIVERABLE: ATR-based position sizing ready, weekly profit tracking active

PHASE 3: IMPORTANT - Real-time Analytics (Week 2)
--------------------------------------------------
Priority: NICE-TO-HAVE for optimization analysis
Estimated Time: 3-4 hours

1. ğŸ”´ Implement Packet D - position_analytics
   - MAE/MFE tracking arrays
   - OnTick() with 50-tick counter
   - 5-second update frequency
2. ğŸ”´ Python handler: handle_packet_d_position_analytics()
3. ğŸ”´ Real-time MAE/MFE display in Output.txt

DELIVERABLE: Live MAE/MFE monitoring during trades

PHASE 4: OPTIMIZATION - Enhanced Features (Week 3-4)
-----------------------------------------------------
Priority: OPTIONAL
Estimated Time: 2-3 hours

1. Connection timeout detection
2. Packet retry logic for critical packets
3. Bandwidth optimization (compression)
4. Enhanced error handling in ACK

================================================================================
SECTION 11: MQL5 IMPLEMENTATION SUMMARY
================================================================================

FILES TO MODIFY:
1. Json.mqh â†’ Create separate BuildPacket_X() functions for each packet type
2. Server.mqh â†’ Add SendPacket_X() wrapper functions
3. GlobalVariables.mqh â†’ Add MAE/MFE tracking arrays and ATR handles
4. News_Analyzer.mq5 â†’ Modify OnTimer(), OnTick(), OnTrade()

NEW GLOBAL VARIABLES (GlobalVariables.mqh):
// MAE/MFE tracking (parallel to openTickets array)
double g_MAE[];
double g_MFE[];

// ATR indicator handles
int g_ATR_Handles[12];  // One for each pair

// Packet sending state
static double g_lastSentBalance = 0.0;
static datetime g_lastBalanceSent = 0;
static int g_tickCounter = 0;

FUNCTION STRUCTURE:
// Json.mqh
string BuildPacket_A_TradeState()      // Existing BuildPayload() renamed
string BuildPacket_B_AccountInfo()     // NEW
string BuildPacket_C_SymbolData()      // NEW
string BuildPacket_D_PositionAnalytics() // NEW
string BuildPacket_E_CloseDetails(ulong ticket) // NEW

// Server.mqh
bool SendPacket_A_TradeState()         // Existing SendArrays() renamed
bool SendPacket_B_AccountInfo()        // NEW
bool SendPacket_C_SymbolData()         // NEW
bool SendPacket_D_PositionAnalytics()  // NEW
bool SendPacket_E_CloseDetails(ulong ticket) // NEW

// News_Analyzer.mq5
void OnInit()
{
    // Initialize ATR handles for all 12 pairs
    InitializeATRHandles();
}

void OnTimer()  // Every 30 seconds
{
    // Always send core state
    SendPacket_A_TradeState();
    
    // Smart send account info (change detection)
    CheckAndSendAccountInfo();
    
    // Always send symbol data (ATR needed for sizing)
    SendPacket_C_SymbolData();
}

void OnTick()
{
    g_tickCounter++;
    
    // Update MAE/MFE on every tick
    UpdateMAE_MFE();
    
    // Send analytics every 50 ticks (~5 seconds)
    if(ArraySize(openTickets) > 0 && g_tickCounter % 50 == 0)
    {
        SendPacket_D_PositionAnalytics();
    }
}

void OnTrade()
{
    // Detect closed positions and send immediately
    DetectAndSendClosedPositions();
}

================================================================================
SECTION 12: COMPLETE DATA FLOW SUMMARY
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MT5 CLIENT â†’ PYTHON SERVER                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Every 30 seconds (OnTimer):
   Packet A â†’ Trade State (open/closed positions)
   Packet B â†’ Account Info (balance/equity) [if changed or 60s elapsed]
   Packet C â†’ Symbol Data (ATR, spreads, prices for 12 pairs)
      â†“
   Python: update_symbols(), update_account_balance(), check_weekly_target()

Every 5 seconds (OnTick, 50-tick counter) [if positions open]:
   Packet D â†’ Position Analytics (MAE/MFE updates)
      â†“
   Python: update_trade_mae_mfe() in _Trades_

Immediate (OnTrade event):
   Packet E â†’ Close Details (final trade data)
      â†“
   Python: calculate_all_metrics(), write_to_csv(), update_weekly_stats()

Result:
   âœ… Real-time CSV logging with all 28 fields
   âœ… Weekly profit tracking with auto-stop
   âœ… ATR-based position sizing ready
   âœ… MAE/MFE optimization data captured
   âœ… <50ms latency from close to CSV write

================================================================================
SECTION 13: TESTING CHECKLIST
================================================================================

Before starting 4-week testing campaign, verify:

â–¡ Packet A sends successfully every 30 seconds
â–¡ Packet B sends on balance change (test with manual trade)
â–¡ Packet C sends successfully with ATR data for all 12 pairs
â–¡ Packet D sends every 5 seconds when positions open
â–¡ Packet E sends immediately on position close (<50ms)
â–¡ Python router correctly identifies all 5 packet types
â–¡ CSV file created with 28 columns on first trade close
â–¡ MAE/MFE values accurate (test with manual trade)
â–¡ Weekly profit target stops trading when reached
â–¡ ATR values populate _Symbols_ dictionary correctly
â–¡ Bandwidth stays under 15 KB/minute during active trading

Stress Test:
â–¡ Open 5 positions simultaneously â†’ check Packet D performance
â–¡ Close all 5 positions â†’ verify 5 Ã— Packet E sent immediately
â–¡ Run for 1 hour â†’ check CSV has all closed trades with correct data
â–¡ Disconnect server â†’ verify OnTimer packets queue/retry logic

================================================================================
END OF DATA COLLECTION SPECIFICATION
================================================================================
Last Updated: 2025-11-07
Version: 2.0 - Multi-Packet Architecture
Total Pages: 13
Implementation Time: 8-12 hours across 4 phases
